name: Sync Upstream Simple

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Sync with upstream
      uses: tgymnich/fork-sync@v1.5.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        owner: QiuSimons
        repo: luci-app-daed
        head: master
        base: master
        merge_method: hardreset
        
    - name: Get latest tag
      id: get-tag
      uses: actions/github-script@v6
      with:
        script: |
          const semver = require('semver');

          const { data: tags } = await github.rest.repos.listTags({
            owner: 'QiuSimons',
            repo: 'luci-app-daed',
            per_page: 100
          });

          if (!tags.length) {
            core.setFailed("No tags found in upstream repo");
            return;
          }

          console.log("获取到的所有 tags:");
          tags.forEach(t => {
            console.log(`Tag: ${t.name}, Commit: ${t.commit.sha}`);
          });

          // 按 semver 排序，取最新的
          const validTags = tags.map(t => t.name).filter(n => semver.valid(n));
          if (!validTags.length) {
            core.setFailed("No valid semver tags found");
            return;
          }

          const latest = validTags.sort(semver.rcompare)[0];
          console.log(`选取的最新 tag: ${latest}`);

          return latest;
        result-encoding: string


    - name: Reset ttaagg to latest tag
      env:
        TAG: ${{ steps.get-tag.outputs.result }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git remote remove upstream 2>/dev/null || true
        git remote add upstream https://github.com/QiuSimons/luci-app-daed.git

        git fetch upstream tag $TAG
        git checkout ttaagg

        cp daed/Makefile /tmp/backup.mk || true
        git reset --hard $TAG
        
        # 从上游Makefile中提取PKG_VERSION的值
        UPSTREAM_VERSION=$(grep -E '^PKG_VERSION\s*[:+]?=\s*' daed/Makefile | head -1 | sed -E 's/^PKG_VERSION\s*[:+]?=\s*//' | tr -d '\r')
        echo "从上游Makefile读取PKG_VERSION: $UPSTREAM_VERSION"
        
        # 更新备份Makefile中的PKG_VERSION
        sed -i "s/^PKG_VERSION[[:space:]]*[:+]*=.*/PKG_VERSION:=$UPSTREAM_VERSION/" /tmp/backup.mk
        echo "已将备份Makefile的PKG_VERSION更新为: $UPSTREAM_VERSION"
        
        rm -rf .github
        cp /tmp/backup.mk daed/Makefile || true

        git add -A
        git commit -m "Sync ttaagg to upstream tag $TAG and restore Makefile" || echo "No changes"

        git push origin ttaagg --force

