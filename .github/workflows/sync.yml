name: Sync Upstream + Tag Branch

on:
  schedule:
    - cron: '0 0 * * *'   # 每天凌晨自动运行
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set Git identity
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    # ---------------------------------------------------------
    # 1. 同步 upstream/master 到本地 master
    # ---------------------------------------------------------
    - name: Add upstream and fetch
      run: |
        git remote remove upstream 2>/dev/null || true
        git remote add upstream https://github.com/QiuSimons/luci-app-daed.git
        git fetch upstream

    - name: Merge upstream/master into local master
      run: |
        git checkout master
        git merge --no-edit upstream/master || true
        git push origin master

    # ---------------------------------------------------------
    # 2. 获取 upstream 最新 release tag + commit
    # ---------------------------------------------------------
    - name: Get latest tag and commit
      id: get-tag
      run: |
        OWNER="QiuSimons"
        REPO="luci-app-daed"

        TAG=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/releases/latest" | jq -r '.tag_name')
        COMMIT_SHA=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/git/refs/tags/$TAG" | jq -r '.object.sha')

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        cp .github/workflows/backup.mk /tmp/backup.mk
    # ---------------------------------------------------------
    # 3. 重置 ttaagg 分支到最新 tag，并更新 Makefile
    # ---------------------------------------------------------
    - name: Reset ttaagg to latest tag
      env:
        TAG: ${{ steps.get-tag.outputs.tag }}
        COMMIT_SHA: ${{ steps.get-tag.outputs.commit_sha }}
      run: |
        git fetch upstream tag $TAG

        # 切换或创建 ttaagg
        git checkout -B ttaagg
        
        # 备份本地 Makefile
        cat /tmp/backup.mk
        
        # 强制 reset 到 tag commit
        git reset --hard $COMMIT_SHA

        # 从 upstream Makefile 读取 PKG_VERSION
        UPSTREAM_VERSION=$(grep -E '^PKG_VERSION\s*[:+]?=\s*' daed/Makefile | head -1 | sed -E 's/^PKG_VERSION\s*[:+]?=\s*//' | tr -d '\r')
        echo "Upstream PKG_VERSION: $UPSTREAM_VERSION"

        # 写回本地 Makefile
        sed -i "s/^PKG_VERSION[[:space:]]*[:+]*=.*/PKG_VERSION:=$UPSTREAM_VERSION/" /tmp/backup.mk
        cp /tmp/backup.mk daed/Makefile
        cat daed/Makefile
        # 删除 upstream 的 workflow
        rm -rf .github

        git add -A
        git commit -m "Sync ttaagg to upstream tag $TAG and update Makefile" || echo "No changes"
        git push origin ttaagg --force-with-lease
