name: Sync Upstream Simple

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Sync with upstream
      uses: tgymnich/fork-sync@v1.5.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        owner: QiuSimons
        repo: luci-app-daed
        head: master
        base: master
        merge_method: hardreset
        
    ############################################################
    # 2. è·å–çˆ¶ä»“åº“æœ€æ–° tag
    ############################################################
    - name: Get latest tag
      id: get-tag
      uses: actions/github-script@v6
      with:
        script: |
          const { data: tags } = await github.rest.repos.listTags({
            owner: 'QiuSimons',
            repo: 'luci-app-daed'
          });

          if (!tags.length) {
            core.setFailed("No tags found in upstream repo");
            return;
          }

          // tags[0] æ˜¯æœ€æ–° tag
          return tags[0].name;
        result-encoding: string

    ############################################################
    # 3. ttaagg åˆ†æ”¯ï¼šæ¢å¤åˆ°æœ€æ–° tag å¯¹åº”çš„ commit
    ############################################################
    - name: Reset ttaagg to latest tag
      env:
        TAG: ${{ steps.get-tag.outputs.result }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git remote remove upstream 2>/dev/null || true
        git remote add upstream https://github.com/QiuSimons/luci-app-daed.git

        git fetch upstream tag $TAG

        git checkout ttaagg

        git reset --hard $TAG

        # åˆ é™¤ä¸Šæ¸¸ workflow
        rm -rf .github

        # ğŸ”¥ğŸ”¥ğŸ”¥ å¿…é¡» commitï¼Œå¦åˆ™ push æ—¶ workflow ä»ç„¶å­˜åœ¨
        git add -A
        git commit -m "Remove upstream workflows" || echo "No changes"

        git push origin ttaagg --force

